{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/ignitionrobotics/ign-common.json"}, "html": {"href": "#!/ignitionrobotics/ign-common"}, "avatar": {"href": "data/bytebucket.org/ravatar/{1dfbdd30-34c5-4b09-82ef-9bfe2917877b}ts=1533303"}}, "type": "repository", "name": "ign-common", "full_name": "ignitionrobotics/ign-common", "uuid": "{1dfbdd30-34c5-4b09-82ef-9bfe2917877b}"}, "links": {"attachments": {"href": "data/repositories/ignitionrobotics/ign-common/issues/44/attachments_page=1.json"}, "self": {"href": "data/repositories/ignitionrobotics/ign-common/issues/44.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-common/issues/44/watch"}, "comments": {"href": "data/repositories/ignitionrobotics/ign-common/issues/44/comments_page=1.json"}, "html": {"href": "#!/ignitionrobotics/ign-common/issues/44/time-sleep-always-returns-time-0-0-even-if"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-common/issues/44/vote"}}, "reporter": {"display_name": "Silvio Traversaro", "uuid": "{34f404cb-5642-4f27-a032-e04c7143d776}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B34f404cb-5642-4f27-a032-e04c7143d776%7D"}, "html": {"href": "https://bitbucket.org/%7B34f404cb-5642-4f27-a032-e04c7143d776%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e1c3e6a0-9a64-4e5f-a668-feebc191c5b6/578caaa1-056c-45a2-8bf9-bee94c3bebef/128"}}, "nickname": "traversaro", "type": "user", "account_id": "557058:e1c3e6a0-9a64-4e5f-a668-feebc191c5b6"}, "title": "Time::Sleep always returns Time(0, 0) even if it was interrupted by a signal on Linux", "component": null, "votes": 0, "watches": 1, "content": {"raw": "# Prerequisites\r\n\r\n* [x] Put an X between the brackets on this line if you have done all of the following:\r\n    * Checked the Q&A board for common solutions: http://answers.gazebosim.org\r\n    * Checked that your issue isn't already filed.\r\n    * Checked that there is not already an Ignition package that provides the described functionality: https://ignitionrobotics.org/libs\r\n\r\n# Description \r\n\r\nInspecting the source code, I noticed that the return value of the `clock_nanosleep` call in the `Time::Sleep` method ( #!/ignitionrobotics/ign-common/src/a78c126bd44e794b7eab74f8b656e726d0f2fd76/src/Time.cc#lines-213 ) is compared against `-1` to check if the sleep was interrupted before the desired elapsed time has passed.  However, in Linux docs ( http://man7.org/linux/man-pages/man2/clock_nanosleep.2.html ) it is explicitly stated that the return value is a positive error message. In particular, the corresponding error should be `EINTR`, that from a quick check on my Ubuntu 18.04 is equal to: \r\n~~~\r\nstraversaro@iiticublap103:~$ cat   /usr/include/asm-generic/errno-base.h  | grep EINTR\r\n#define\tEINTR\t\t 4\t/* Interrupted system call */\r\n~~~\r\nSo, even if `clock_nanosleep` returns `EINTR` the return value of the Sleep is always Time(0, 0).\r\n\r\nThe same problem is afflicting the Gazebo's version of the method. \r\n\r\n# Steps to Reproduce\r\nI did not attempt to reproduce the issue, but it should be reproducible by having a process sleeping for a long time, waking it with a signal before the wait period ended, and checking the return value of the `Sleep` method. \r\n\r\n**Expected behavior:**  \r\n\r\nInspecting the rest of the code, I thought that the `Sleep` method was returning the remainder of time still need to pass before the requested time was elapsed, but according to the docs it is supposed to return the \"Time actually slept\", so I am not really sure about what the actual expected behavior his. \r\n\r\n**Actual behavior:**\r\n\r\nSee \"Steps to Reproduced\". I did not actually reproduced the error. \r\n\r\n**Reproduces how often:** \r\n\r\nThe wrong check is done always,  but when the `clock_nanosleep` is returning 0, the if is working as expected.\r\n\r\n# Versions\r\n\r\nignition-common, branch gz11\r\n\r\n# Additional Information", "markup": "markdown", "html": "<h1 id=\"markdown-header-prerequisites\">Prerequisites</h1>\n<ul>\n<li>[x] Put an X between the brackets on this line if you have done all of the following:<ul>\n<li>Checked the Q&amp;A board for common solutions: <a href=\"http://answers.gazebosim.org\" rel=\"nofollow\" class=\"ap-connect-link\">http://answers.gazebosim.org</a></li>\n<li>Checked that your issue isn't already filed.</li>\n<li>Checked that there is not already an Ignition package that provides the described functionality: <a href=\"https://ignitionrobotics.org/libs\" rel=\"nofollow\" class=\"ap-connect-link\">https://ignitionrobotics.org/libs</a></li>\n</ul>\n</li>\n</ul>\n<h1 id=\"markdown-header-description\">Description</h1>\n<p>Inspecting the source code, I noticed that the return value of the <code>clock_nanosleep</code> call in the <code>Time::Sleep</code> method ( <a href=\"#!/ignitionrobotics/ign-common/src/a78c126bd44e794b7eab74f8b656e726d0f2fd76/src/Time.cc#lines-213\" rel=\"nofollow\" class=\"ap-connect-link\">#!/ignitionrobotics/ign-common/src/a78c126bd44e794b7eab74f8b656e726d0f2fd76/src/Time.cc#lines-213</a> ) is compared against <code>-1</code> to check if the sleep was interrupted before the desired elapsed time has passed.  However, in Linux docs ( <a href=\"http://man7.org/linux/man-pages/man2/clock_nanosleep.2.html\" rel=\"nofollow\" class=\"ap-connect-link\">http://man7.org/linux/man-pages/man2/clock_nanosleep.2.html</a> ) it is explicitly stated that the return value is a positive error message. In particular, the corresponding error should be <code>EINTR</code>, that from a quick check on my Ubuntu 18.04 is equal to: </p>\n<div class=\"codehilite\"><pre><span></span>straversaro@iiticublap103:~$ cat   /usr/include/asm-generic/errno-base.h  | grep EINTR\n#define EINTR        4  /* Interrupted system call */\n</pre></div>\n\n\n<p>So, even if <code>clock_nanosleep</code> returns <code>EINTR</code> the return value of the Sleep is always Time(0, 0).</p>\n<p>The same problem is afflicting the Gazebo's version of the method. </p>\n<h1 id=\"markdown-header-steps-to-reproduce\">Steps to Reproduce</h1>\n<p>I did not attempt to reproduce the issue, but it should be reproducible by having a process sleeping for a long time, waking it with a signal before the wait period ended, and checking the return value of the <code>Sleep</code> method. </p>\n<p><strong>Expected behavior:</strong>  </p>\n<p>Inspecting the rest of the code, I thought that the <code>Sleep</code> method was returning the remainder of time still need to pass before the requested time was elapsed, but according to the docs it is supposed to return the \"Time actually slept\", so I am not really sure about what the actual expected behavior his. </p>\n<p><strong>Actual behavior:</strong></p>\n<p>See \"Steps to Reproduced\". I did not actually reproduced the error. </p>\n<p><strong>Reproduces how often:</strong> </p>\n<p>The wrong check is done always,  but when the <code>clock_nanosleep</code> is returning 0, the if is working as expected.</p>\n<h1 id=\"markdown-header-versions\">Versions</h1>\n<p>ignition-common, branch gz11</p>\n<h1 id=\"markdown-header-additional-information\">Additional Information</h1>", "type": "rendered"}, "assignee": {"display_name": "Nate Koenig", "uuid": "{c862cdd9-fcc8-4419-9fc7-e20db14b8fcb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bc862cdd9-fcc8-4419-9fc7-e20db14b8fcb%7D"}, "html": {"href": "https://bitbucket.org/%7Bc862cdd9-fcc8-4419-9fc7-e20db14b8fcb%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:095b1e12-74ed-4e20-b44f-2f0745b616e0/ca24bb11-4787-4b14-a20d-d91835e9bde2/128"}}, "nickname": "Nathan Koenig", "type": "user", "account_id": "557058:095b1e12-74ed-4e20-b44f-2f0745b616e0"}, "state": "resolved", "version": null, "edited_on": null, "created_on": "2018-11-21T21:12:31.252425+00:00", "milestone": null, "updated_on": "2019-02-07T21:18:13.404688+00:00", "type": "issue", "id": 44}