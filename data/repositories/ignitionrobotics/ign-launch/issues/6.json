{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/ignitionrobotics/ign-launch.json"}, "html": {"href": "#!/ignitionrobotics/ign-launch"}, "avatar": {"href": "data/bytebucket.org/ravatar/{b6981a69-ba64-447a-9739-662a89b25082}ts=2278389"}}, "type": "repository", "name": "ign-launch", "full_name": "ignitionrobotics/ign-launch", "uuid": "{b6981a69-ba64-447a-9739-662a89b25082}"}, "links": {"attachments": {"href": "data/repositories/ignitionrobotics/ign-launch/issues/6/attachments_page=1.json"}, "self": {"href": "data/repositories/ignitionrobotics/ign-launch/issues/6.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-launch/issues/6/watch"}, "comments": {"href": "data/repositories/ignitionrobotics/ign-launch/issues/6/comments_page=1.json"}, "html": {"href": "#!/ignitionrobotics/ign-launch/issues/6/deadlock-at-startup-due-to-sigchild"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-launch/issues/6/vote"}}, "reporter": {"display_name": "Addisu Z. Taddese", "uuid": "{9d7fdc68-d270-4080-bf03-4df0d0dbf635}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B9d7fdc68-d270-4080-bf03-4df0d0dbf635%7D"}, "html": {"href": "https://bitbucket.org/%7B9d7fdc68-d270-4080-bf03-4df0d0dbf635%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:90bc87b0-2886-4377-a17c-3a6629a697ff/afbf9be5-1e4c-4810-89d4-e58831f34b11/128"}}, "nickname": "azeey", "type": "user", "account_id": "557058:90bc87b0-2886-4377-a17c-3a6629a697ff"}, "title": "Deadlock at startup due to SIGCHILD", "component": null, "votes": 0, "watches": 1, "content": {"raw": "I have encountered deadlocks multiple times when launching `competition` in SubT. I've traced it down to the fact that `ManagerPrivate::OnSigChild` uses non async-signal-safe functions which could cause deadlocks at startup when child processes exit. I've attached a simple `.ign` file that reproduces the issue for me. Basically, it starts gazebo and a bunch of `sleep` commands with random amounts of sleep. The deadlock usually occurs deep inside malloc.\r\n\r\n```\r\n#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\r\n#1  0x00007fe0f55d72db in __GI___libc_malloc (bytes=bytes@entry=513) at malloc.c:3063\r\n#2  0x00007fe0f1f26258 in operator new (sz=513) at ../../../../src/libstdc++-v3/libsupc++/new_op.cc:50\r\n#3  0x00007fe0f1fb817d in std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::reserve (this=this@entry=0x7ffcfe19afb0, __res=<optimized out>)\r\n    at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/basic_string.h:167\r\n#4  0x00007fe0f1fabdd8 in std::__cxx11::basic_stringbuf<char, std::char_traits<char>, std::allocator<char> >::overflow (this=0x7ffcfe19b148, __c=97) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/ext/new_allocator.h:86\r\n#5  0x00007fe0f1fb65ab in std::basic_streambuf<char, std::char_traits<char> >::xsputn (this=0x7ffcfe19b148, __s=0x563654769b78 \"anager.cc:295] \", __n=23) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/char_traits.h:371\r\n#6  0x00007fe0f1fa6cb4 in std::basic_streambuf<char, std::char_traits<char> >::sputn (__n=23, __s=0x563654769b70 \"[Dbg] [Manager.cc:295] \", this=<optimized out>) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/streambuf:457\r\n#7  std::__ostream_write<char, std::char_traits<char> > (__n=23, __s=0x563654769b70 \"[Dbg] [Manager.cc:295] \", __out=...) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/ostream_insert.h:50\r\n#8  std::__ostream_insert<char, std::char_traits<char> > (__out=..., __s=0x563654769b70 \"[Dbg] [Manager.cc:295] \", __n=23) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/ostream_insert.h:101\r\n#9  0x00007fe0f2656ed7 in std::operator<< <char, std::char_traits<char>, std::allocator<char> > (__str=\"[Dbg] [Manager.cc:295] \", __os=...) at /usr/include/c++/8/bits/basic_string.h:6323\r\n#10 ignition::common::Logger::Buffer::sync() () at /home/addisu/ws/subt_ign/src/ign-common/src/Console.cc:148\r\n#11 0x00007fe0f1fa65b8 in std::basic_streambuf<char, std::char_traits<char> >::pubsync (this=<optimized out>) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/streambuf:278\r\n#12 std::ostream::sentry::~sentry (this=0x7ffcfe19b340, __in_chrg=<optimized out>) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/ostream:460\r\n#13 0x00007fe0f1fa6c7a in std::__ostream_insert<char, std::char_traits<char> > (__out=..., __s=0x5636548e55b0 \"[Dbg] [Manager.cc:295] \", __n=<optimized out>)\r\n    at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/ios_base.h:727\r\n#14 0x00007fe0f26577b8 in std::operator<< <char, std::char_traits<char>, std::allocator<char> > (__str=\"[Dbg] [Manager.cc:295] \", __os=...) at /usr/include/c++/8/bits/basic_string.h:6323\r\n#15 ignition::common::Logger::operator()(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&, int) () at /home/addisu/ws/subt_ign/src/ign-common/src/Console.cc:111\r\n#16 0x00007fe0f2a9d4bc in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::OnSigChild(int) () at /usr/include/c++/8/bits/basic_string.h:252\r\n#17 <signal handler called>\r\n#18 0x00007fe0f5624b1a in __libc_fork () at ../sysdeps/nptl/fork.c:135\r\n#19 0x00007fe0f2a9c5fb in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::RunExecutable(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&, std::vector<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >, std::allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > > const&, bool, std::__cxx11::list<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >, std::allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > > const&) () at /home/addisu/ws/subt_ign/src/ign-launch/src/Manager.cc:401\r\n#20 0x00007fe0f2a9dd97 in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::ParseExecutables(tinyxml2::XMLElement const*) () at /home/addisu/ws/subt_ign/src/ign-launch/src/Manager.cc:541\r\n#21 0x00007fe0f2a9f36d in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::ParseConfig(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) ()\r\n    at /home/addisu/ws/subt_ign/src/ign-launch/src/Manager.cc:356\r\n#22 0x00007fe0f2a9f60f in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::Manager::RunConfig(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) () at /usr/include/c++/8/bits/unique_ptr.h:342\r\n#23 0x00007fe0f2a9b6db in run () at /usr/include/c++/8/bits/char_traits.h:287\r\n#24 0x00007fe0f2eaedae in ffi_call_unix64 () from /usr/lib/x86_64-linux-gnu/libffi.so.6\r\n#25 0x00007fe0f2eae71f in ffi_call () from /usr/lib/x86_64-linux-gnu/libffi.so.6\r\n#26 0x00007fe0f30b58f8 in ?? () from /usr/lib/x86_64-linux-gnu/ruby/2.5.0/fiddle.so\r\n#27 0x00007fe0f5ab0b9b in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#28 0x00007fe0f30b568d in ?? () from /usr/lib/x86_64-linux-gnu/ruby/2.5.0/fiddle.so\r\n#29 0x00007fe0f5ad7289 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#30 0x00007fe0f5ae57b3 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#31 0x00007fe0f5adbc45 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#32 0x00007fe0f5ae1a24 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#33 0x00007fe0f59bc0c4 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#34 0x00007fe0f59bdf4d in ruby_exec_node () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#35 0x00007fe0f59c042e in ruby_run_node () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\r\n#36 0x00005636536798cb in ?? ()\r\n#37 0x00007fe0f5561b97 in __libc_start_main (main=0x563653679880, argc=5, argv=0x7ffcfe19d108, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7ffcfe19d0f8) at ../csu/libc-start.c:310\r\n#38 0x00005636536798fa in _start ()\r\n/home/addisu/ws/subt_ign/src/ign-sensors - __lll_lock_wait_private\r\n```", "markup": "markdown", "html": "<p>I have encountered deadlocks multiple times when launching <code>competition</code> in SubT. I've traced it down to the fact that <code>ManagerPrivate::OnSigChild</code> uses non async-signal-safe functions which could cause deadlocks at startup when child processes exit. I've attached a simple <code>.ign</code> file that reproduces the issue for me. Basically, it starts gazebo and a bunch of <code>sleep</code> commands with random amounts of sleep. The deadlock usually occurs deep inside malloc.</p>\n<div class=\"codehilite\"><pre><span></span>#0  __lll_lock_wait_private () at ../sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:95\n#1  0x00007fe0f55d72db in __GI___libc_malloc (bytes=bytes@entry=513) at malloc.c:3063\n#2  0x00007fe0f1f26258 in operator new (sz=513) at ../../../../src/libstdc++-v3/libsupc++/new_op.cc:50\n#3  0x00007fe0f1fb817d in std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::reserve (this=this@entry=0x7ffcfe19afb0, __res=&lt;optimized out&gt;)\n    at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/basic_string.h:167\n#4  0x00007fe0f1fabdd8 in std::__cxx11::basic_stringbuf&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::overflow (this=0x7ffcfe19b148, __c=97) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/ext/new_allocator.h:86\n#5  0x00007fe0f1fb65ab in std::basic_streambuf&lt;char, std::char_traits&lt;char&gt; &gt;::xsputn (this=0x7ffcfe19b148, __s=0x563654769b78 &quot;anager.cc:295] &quot;, __n=23) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/char_traits.h:371\n#6  0x00007fe0f1fa6cb4 in std::basic_streambuf&lt;char, std::char_traits&lt;char&gt; &gt;::sputn (__n=23, __s=0x563654769b70 &quot;[Dbg] [Manager.cc:295] &quot;, this=&lt;optimized out&gt;) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/streambuf:457\n#7  std::__ostream_write&lt;char, std::char_traits&lt;char&gt; &gt; (__n=23, __s=0x563654769b70 &quot;[Dbg] [Manager.cc:295] &quot;, __out=...) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/ostream_insert.h:50\n#8  std::__ostream_insert&lt;char, std::char_traits&lt;char&gt; &gt; (__out=..., __s=0x563654769b70 &quot;[Dbg] [Manager.cc:295] &quot;, __n=23) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/ostream_insert.h:101\n#9  0x00007fe0f2656ed7 in std::operator&lt;&lt; &lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; (__str=&quot;[Dbg] [Manager.cc:295] &quot;, __os=...) at /usr/include/c++/8/bits/basic_string.h:6323\n#10 ignition::common::Logger::Buffer::sync() () at /home/addisu/ws/subt_ign/src/ign-common/src/Console.cc:148\n#11 0x00007fe0f1fa65b8 in std::basic_streambuf&lt;char, std::char_traits&lt;char&gt; &gt;::pubsync (this=&lt;optimized out&gt;) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/streambuf:278\n#12 std::ostream::sentry::~sentry (this=0x7ffcfe19b340, __in_chrg=&lt;optimized out&gt;) at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/ostream:460\n#13 0x00007fe0f1fa6c7a in std::__ostream_insert&lt;char, std::char_traits&lt;char&gt; &gt; (__out=..., __s=0x5636548e55b0 &quot;[Dbg] [Manager.cc:295] &quot;, __n=&lt;optimized out&gt;)\n    at /build/gcc-8-IFl8q6/gcc-8-8.3.0/build/x86_64-linux-gnu/libstdc++-v3/include/bits/ios_base.h:727\n#14 0x00007fe0f26577b8 in std::operator&lt;&lt; &lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; (__str=&quot;[Dbg] [Manager.cc:295] &quot;, __os=...) at /usr/include/c++/8/bits/basic_string.h:6323\n#15 ignition::common::Logger::operator()(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, int) () at /home/addisu/ws/subt_ign/src/ign-common/src/Console.cc:111\n#16 0x00007fe0f2a9d4bc in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::OnSigChild(int) () at /usr/include/c++/8/bits/basic_string.h:252\n#17 &lt;signal handler called&gt;\n#18 0x00007fe0f5624b1a in __libc_fork () at ../sysdeps/nptl/fork.c:135\n#19 0x00007fe0f2a9c5fb in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::RunExecutable(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, std::vector&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::allocator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt; &gt; const&amp;, bool, std::__cxx11::list&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::allocator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt; &gt; const&amp;) () at /home/addisu/ws/subt_ign/src/ign-launch/src/Manager.cc:401\n#20 0x00007fe0f2a9dd97 in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::ParseExecutables(tinyxml2::XMLElement const*) () at /home/addisu/ws/subt_ign/src/ign-launch/src/Manager.cc:541\n#21 0x00007fe0f2a9f36d in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::ManagerPrivate::ParseConfig(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) ()\n    at /home/addisu/ws/subt_ign/src/ign-launch/src/Manager.cc:356\n#22 0x00007fe0f2a9f60f in ignition::launch::IGNITION_LAUNCH_VERSION_NAMESPACE::Manager::RunConfig(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) () at /usr/include/c++/8/bits/unique_ptr.h:342\n#23 0x00007fe0f2a9b6db in run () at /usr/include/c++/8/bits/char_traits.h:287\n#24 0x00007fe0f2eaedae in ffi_call_unix64 () from /usr/lib/x86_64-linux-gnu/libffi.so.6\n#25 0x00007fe0f2eae71f in ffi_call () from /usr/lib/x86_64-linux-gnu/libffi.so.6\n#26 0x00007fe0f30b58f8 in ?? () from /usr/lib/x86_64-linux-gnu/ruby/2.5.0/fiddle.so\n#27 0x00007fe0f5ab0b9b in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#28 0x00007fe0f30b568d in ?? () from /usr/lib/x86_64-linux-gnu/ruby/2.5.0/fiddle.so\n#29 0x00007fe0f5ad7289 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#30 0x00007fe0f5ae57b3 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#31 0x00007fe0f5adbc45 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#32 0x00007fe0f5ae1a24 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#33 0x00007fe0f59bc0c4 in ?? () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#34 0x00007fe0f59bdf4d in ruby_exec_node () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#35 0x00007fe0f59c042e in ruby_run_node () from /usr/lib/x86_64-linux-gnu/libruby-2.5.so.2.5\n#36 0x00005636536798cb in ?? ()\n#37 0x00007fe0f5561b97 in __libc_start_main (main=0x563653679880, argc=5, argv=0x7ffcfe19d108, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7ffcfe19d0f8) at ../csu/libc-start.c:310\n#38 0x00005636536798fa in _start ()\n/home/addisu/ws/subt_ign/src/ign-sensors - __lll_lock_wait_private\n</pre></div>", "type": "rendered"}, "assignee": {"display_name": "Michael Carroll", "uuid": "{17dbbc15-cbc0-42f0-a985-cde9061c78a0}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B17dbbc15-cbc0-42f0-a985-cde9061c78a0%7D"}, "html": {"href": "https://bitbucket.org/%7B17dbbc15-cbc0-42f0-a985-cde9061c78a0%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:65740f22-cc56-4418-9608-7e17d0ed47b7/2aa259f5-4de1-4f68-9156-eded72041d84/128"}}, "nickname": "Michael Carroll", "type": "user", "account_id": "557058:65740f22-cc56-4418-9608-7e17d0ed47b7"}, "state": "new", "version": null, "edited_on": null, "created_on": "2019-07-12T15:39:41.549940+00:00", "milestone": null, "updated_on": "2019-07-12T18:39:07.993195+00:00", "type": "issue", "id": 6}