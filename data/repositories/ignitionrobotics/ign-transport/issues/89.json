{"priority": "minor", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/ignitionrobotics/ign-transport.json"}, "html": {"href": "#!/ignitionrobotics/ign-transport"}, "avatar": {"href": "data/bytebucket.org/ravatar/{4249390a-7f55-404b-990d-817ba94cc7ac}ts=1533306"}}, "type": "repository", "name": "ign-transport", "full_name": "ignitionrobotics/ign-transport", "uuid": "{4249390a-7f55-404b-990d-817ba94cc7ac}"}, "links": {"attachments": {"href": "data/repositories/ignitionrobotics/ign-transport/issues/89/attachments_page=1.json"}, "self": {"href": "data/repositories/ignitionrobotics/ign-transport/issues/89.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-transport/issues/89/watch"}, "comments": {"href": "data/repositories/ignitionrobotics/ign-transport/issues/89/comments_page=1.json"}, "html": {"href": "#!/ignitionrobotics/ign-transport/issues/89/discoveryhh-registernetiface-fails-to-call"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-transport/issues/89/vote"}}, "reporter": {"display_name": "Martin Pecka", "uuid": "{41691c43-4ae0-49ba-ba45-3c36439f5af2}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B41691c43-4ae0-49ba-ba45-3c36439f5af2%7D"}, "html": {"href": "https://bitbucket.org/%7B41691c43-4ae0-49ba-ba45-3c36439f5af2%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/d1ad32a09564f856909994613fdbc37cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsMP-1.png"}}, "nickname": "peci1", "type": "user", "account_id": "557058:434ecab2-e510-4ede-8f9a-1c2a5a4032e1"}, "title": "Discovery.hh:RegisterNetIface fails to call IP_ADD_MEMBERSHIP on subinterface", "component": null, "votes": 0, "watches": 1, "content": {"raw": "The problem is that [RegisterNetIface](#!/ignitionrobotics/ign-transport/src/c14cdb42c65900f284e9831c0f2f78033bfa2615/include/ignition/transport/Discovery.hh#Discovery.hh-1036) doesn't check if the added interface is a real interface or a subinterface. The interface and its subinterfaces share the same index (`SIOCGIFINDEX`), and practical tests show that `IP_ADD_MEMBERSHIP` can only be called once on each index.\n\nOn a system with a subinterface defined, gzserver emits the following error on start (I extended the error message a bit to receive more useful debug information):\n\n    Error setting socket option (IP_ADD_MEMBERSHIP) to (224.0.0.7, 192.168.84.152).Address already in use\n\nThe error doesn't seem to be a problem, but it's just pretty difficult to figure this out. The discovery should thus either limit its search to real interfaces, or it should catch this particular error and swallow it somehow.\n\nI asked for expert opinion here, and there's also an MWE showing this behavior: https://stackoverflow.com/questions/49819010/ip-add-membership-fails-when-set-both-on-interface-and-its-subinterface-is-that", "markup": "markdown", "html": "<p>The problem is that <a data-is-external-link=\"true\" href=\"#!/ignitionrobotics/ign-transport/src/c14cdb42c65900f284e9831c0f2f78033bfa2615/include/ignition/transport/Discovery.hh#Discovery.hh-1036\" rel=\"nofollow\">RegisterNetIface</a> doesn't check if the added interface is a real interface or a subinterface. The interface and its subinterfaces share the same index (<code>SIOCGIFINDEX</code>), and practical tests show that <code>IP_ADD_MEMBERSHIP</code> can only be called once on each index.</p>\n<p>On a system with a subinterface defined, gzserver emits the following error on start (I extended the error message a bit to receive more useful debug information):</p>\n<div class=\"codehilite\"><pre><span></span>Error setting socket option (IP_ADD_MEMBERSHIP) to (224.0.0.7, 192.168.84.152).Address already in use\n</pre></div>\n\n\n<p>The error doesn't seem to be a problem, but it's just pretty difficult to figure this out. The discovery should thus either limit its search to real interfaces, or it should catch this particular error and swallow it somehow.</p>\n<p>I asked for expert opinion here, and there's also an MWE showing this behavior: <a href=\"https://stackoverflow.com/questions/49819010/ip-add-membership-fails-when-set-both-on-interface-and-its-subinterface-is-that\" rel=\"nofollow\" class=\"ap-connect-link\">https://stackoverflow.com/questions/49819010/ip-add-membership-fails-when-set-both-on-interface-and-its-subinterface-is-that</a></p>", "type": "rendered"}, "assignee": null, "state": "resolved", "version": null, "edited_on": null, "created_on": "2018-05-02T11:26:44.366828+00:00", "milestone": null, "updated_on": "2018-06-14T16:56:21.458612+00:00", "type": "issue", "id": 89}