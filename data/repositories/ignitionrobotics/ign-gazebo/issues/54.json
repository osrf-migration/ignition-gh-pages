{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/ignitionrobotics/ign-gazebo.json"}, "html": {"href": "#!/ignitionrobotics/ign-gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{f98d11fe-f287-4dfb-99c3-e2b76a13232e}ts=2082645"}}, "type": "repository", "name": "ign-gazebo", "full_name": "ignitionrobotics/ign-gazebo", "uuid": "{f98d11fe-f287-4dfb-99c3-e2b76a13232e}"}, "links": {"attachments": {"href": "data/repositories/ignitionrobotics/ign-gazebo/issues/54/attachments_page=1.json"}, "self": {"href": "data/repositories/ignitionrobotics/ign-gazebo/issues/54.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-gazebo/issues/54/watch"}, "comments": {"href": "data/repositories/ignitionrobotics/ign-gazebo/issues/54/comments_page=1.json"}, "html": {"href": "#!/ignitionrobotics/ign-gazebo/issues/54/double-free-or-corruption-fasttop"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/ignitionrobotics/ign-gazebo/issues/54/vote"}}, "reporter": {"display_name": "Juan Oxoby", "uuid": "{7d3743fc-bfd8-4e48-a53b-9cc0a264f66d}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B7d3743fc-bfd8-4e48-a53b-9cc0a264f66d%7D"}, "html": {"href": "https://bitbucket.org/%7B7d3743fc-bfd8-4e48-a53b-9cc0a264f66d%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/3d4b2394d4fc0cf52ce2d5d797d60b25d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsJO-0.png"}}, "nickname": "Juan Oxoby", "type": "user", "account_id": "5e544adb96f7d50ca05430ce"}, "title": "double free or corruption (fasttop)", "component": null, "votes": 0, "watches": 2, "content": {"raw": "# Prerequisites\r\n\r\n* \\[ X\\] Put an X between the brackets on this line if you have done all of the following:\r\n\r\n    * Checked the Q&A board for common solutions: [http://answers.gazebosim.org](http://answers.gazebosim.org)\r\n    * Checked that your issue isn't already filed.\r\n    * Checked that there is not already an Ignition package that provides the described functionality: [https://ignitionrobotics.org/libs](https://ignitionrobotics.org/libs)\r\n    \r\n\r\n# Description\r\n\r\n`double free or corruption (fasttop)` after executing a simple program using `Server`.\r\n\r\n# Steps to Reproduce\r\n\r\nBuild and run the following test program:\r\n\r\n```c++\r\n#include <ignition/gazebo/Server.hh>\r\n\r\nusing namespace ignition;\r\nusing namespace gazebo;\r\n\r\n/////////////////////////////////////////////////\r\nint main()\r\n{\r\n  ServerConfig serverConfig;\r\n  Server server(serverConfig);\r\n  server.Run();\r\n  return 0;\r\n}\r\n```\r\n\r\n**Expected behavior:**\r\n\r\nThe program should run and finish without any problems.\r\n\r\n**Actual behavior:**\r\n\r\nAt the end of the execution, the program fails with this output:\r\n\r\n`double free or corruption (fasttop)`  \r\n`Aborted (core dumped)`\r\n\r\n**Reproduces how often:**\r\n\r\nAlways.\r\n\r\n# Versions\r\n\r\ngcc \\(Ubuntu 8.3.0-6ubuntu1~18.04.1\\) 8.3.0\r\n\r\nldd \\(Ubuntu GLIBC 2.27-3ubuntu1\\) 2.27\r\n\r\n# Additional Information\r\n\r\nWhen running with valgrind:\r\n\r\n`valgrind --keep-stacktraces=alloc-and-free crash_test`\r\n\r\n> ==29049== Memcheck, a memory error detector  \r\n> ==29049== Copyright \\(C\\) 2002-2017, and GNU GPL'd, by Julian Seward et al.  \r\n> ==29049== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info  \r\n> ==29049== Command: bin/crash\\_test  \r\n> ==29049==  \r\n> ==29049== Invalid free\\(\\) / delete / delete\\[\\] / realloc\\(\\)  \r\n> ==29049== at 0x4C3123B: operator delete\\(void\\*\\) \\(in /usr/lib/valgrind/vgpreload\\_memcheck-amd64-linux.so\\)  \r\n> ==29049== by 0x580F040: \\_\\_run\\_exit\\_handlers \\(exit.c:108\\)  \r\n> ==29049== by 0x580F139: exit \\(exit.c:139\\)  \r\n> ==29049== by 0x57EDB9D: \\(below main\\) \\(libc-start.c:344\\)  \r\n> ==29049== Address 0x1f97e1d0 is 0 bytes inside a block of size 29 free'd  \r\n> ==29049== at 0x4C3123B: operator delete\\(void\\*\\) \\(in /usr/lib/valgrind/vgpreload\\_memcheck-amd64-linux.so\\)  \r\n> ==29049== by 0x580F040: \\_\\_run\\_exit\\_handlers \\(exit.c:108\\)  \r\n> ==29049== by 0x580F139: exit \\(exit.c:139\\)  \r\n> ==29049== by 0x57EDB9D: \\(below main\\) \\(libc-start.c:344\\)  \r\n> ==29049== Block was alloc'd at  \r\n> ==29049== at 0x4C3017F: operator new\\(unsigned long\\) \\(in /usr/lib/valgrind/vgpreload\\_memcheck-amd64-linux.so\\)  \r\n> ==29049== by 0x2ABF365D: ??? \\(in /opt/ros/melodic/lib/liboctomap.so.1.9.0\\)  \r\n> ==29049== by 0x4010732: call\\_init \\(dl-init.c:72\\)  \r\n> ==29049== by 0x4010732: \\_dl\\_init \\(dl-init.c:119\\)  \r\n> ==29049== by 0x40151FE: dl\\_open\\_worker \\(dl-open.c:522\\)  \r\n> ==29049== by 0x59332DE: \\_dl\\_catch\\_exception \\(dl-error-skeleton.c:196\\)  \r\n> ==29049== by 0x40147C9: \\_dl\\_open \\(dl-open.c:605\\)  \r\n> ==29049== by 0x972CF95: dlopen\\_doit \\(dlopen.c:66\\)  \r\n> ==29049== by 0x59332DE: \\_dl\\_catch\\_exception \\(dl-error-skeleton.c:196\\)  \r\n> ==29049== by 0x593336E: \\_dl\\_catch\\_error \\(dl-error-skeleton.c:215\\)  \r\n> ==29049== by 0x972D734: \\_dlerror\\_run \\(dlerror.c:162\\)  \r\n> ==29049== by 0x972D050: dlopen@@GLIBC\\_2.2.5 \\(dlopen.c:87\\)  \r\n> ==29049== by 0x663A3A9: ignition::plugin::Loader::Implementation::LoadLib\\(std::\\_\\_cxx11::basic\\_string<char, std::char\\_traits<char>, std::allocator<char> > const&\\) \\([Loader.cc:457](http://Loader.cc:457)\\)  \r\n> ==29049==  \r\n> ==29049==  \r\n> ==29049== HEAP SUMMARY:  \r\n> ==29049== in use at exit: 663,703 bytes in 9,163 blocks  \r\n> ==29049== total heap usage: 211,095 allocs, 201,934 frees, 31,648,420 bytes allocated  \r\n> ==29049==  \r\n> ==29049== LEAK SUMMARY:  \r\n> ==29049== definitely lost: 3,573 bytes in 212 blocks  \r\n> ==29049== indirectly lost: 0 bytes in 0 blocks  \r\n> ==29049== possibly lost: 0 bytes in 0 blocks  \r\n> ==29049== still reachable: 660,130 bytes in 8,951 blocks  \r\n> ==29049== suppressed: 0 bytes in 0 blocks  \r\n> ==29049== Rerun with --leak-check=full to see details of leaked memory  \r\n> ==29049==  \r\n> ==29049== For counts of detected and suppressed errors, rerun with: -v  \r\n> ==29049== ERROR SUMMARY: 2 errors from 1 contexts \\(suppressed: 0 from 0\\)\r\n\r\nPointed to line: [#!/ignitionrobotics/ign-plugin/src/8f724376b94bf6e298a7d66a37e5e5a68a329409/loader/src/Loader.cc#lines-457](#!/ignitionrobotics/ign-plugin/src/8f724376b94bf6e298a7d66a37e5e5a68a329409/loader/src/Loader.cc#lines-457)\r\n\r\nIf running with address sanitizer, we get:\r\n\r\n> =================================================================  \r\n> ==16996==ERROR: AddressSanitizer: attempting double-free on 0x60300026dc10 in thread T0:  \r\n> \\#0 0x55fafdc08dc0 in operator delete\\(void\\*\\) \\(bin/crash\\_test\\+0xd7dc0\\)  \r\n> ~~#1~~ 0x7f658031e040 \\(/lib/x86\\_64-linux-gnu/libc.so.6\\+0x43040\\)  \r\n> ~~#2~~ 0x7f658031e139 in exit \\(/lib/x86\\_64-linux-gnu/libc.so.6\\+0x43139\\)  \r\n> \\#3 0x7f65802fcb9d in \\_\\_libc\\_start\\_main \\(/lib/x86\\_64-linux-gnu/libc.so.6\\+0x21b9d\\)  \r\n> \\#4 0x55fafdb39b89 in \\_start \\(build/bin/crash\\_test\\+0x8b89\\)\r\n>\r\n> 0x60300026dc10 is located 0 bytes inside of 29-byte region \\[0x60300026dc10,0x60300026dc2d\\)  \r\n> freed by thread T0 here:  \r\n> \\#0 0x55fafdc08dc0 in operator delete\\(void\\*\\) \\(build/bin/crash\\_test\\+0xd7dc0\\)  \r\n> ~~#1~~ 0x7f658031e040 \\(/lib/x86\\_64-linux-gnu/libc.so.6\\+0x43040\\)\r\n>\r\n> previously allocated by thread T0 here:  \r\n> \\#0 0x55fafdc07f10 in operator new\\(unsigned long\\) \\(build/bin/crash\\_test\\+0xd6f10\\)  \r\n> ~~#1~~ 0x7f655b39565d \\(/opt/ros/melodic/lib/liboctomap.so.1.9\\+0x1465d\\)\r\n>\r\n> SUMMARY: AddressSanitizer: double-free \\(build/bin/crash\\_test\\+0xd7dc0\\) in operator delete\\(void\\*\\)  \r\n> ==16996==ABORTING\r\n\r\n\u200c", "markup": "markdown", "html": "<h1 id=\"markdown-header-prerequisites\">Prerequisites</h1>\n<ul>\n<li>\n<p>[ X] Put an X between the brackets on this line if you have done all of the following:</p>\n<ul>\n<li>Checked the Q&amp;A board for common solutions: <a data-is-external-link=\"true\" href=\"http://answers.gazebosim.org\" rel=\"nofollow\">http://answers.gazebosim.org</a></li>\n<li>Checked that your issue isn't already filed.</li>\n<li>Checked that there is not already an Ignition package that provides the described functionality: <a data-is-external-link=\"true\" href=\"https://ignitionrobotics.org/libs\" rel=\"nofollow\">https://ignitionrobotics.org/libs</a></li>\n</ul>\n</li>\n</ul>\n<h1 id=\"markdown-header-description\">Description</h1>\n<p><code>double free or corruption (fasttop)</code> after executing a simple program using <code>Server</code>.</p>\n<h1 id=\"markdown-header-steps-to-reproduce\">Steps to Reproduce</h1>\n<p>Build and run the following test program:</p>\n<div class=\"codehilite language-c++\"><pre><span></span><span class=\"cp\">#include</span> <span class=\"cpf\">&lt;ignition/gazebo/Server.hh&gt;</span><span class=\"cp\"></span>\n\n<span class=\"k\">using</span> <span class=\"k\">namespace</span> <span class=\"n\">ignition</span><span class=\"p\">;</span>\n<span class=\"k\">using</span> <span class=\"k\">namespace</span> <span class=\"n\">gazebo</span><span class=\"p\">;</span>\n\n<span class=\"c1\">/////////////////////////////////////////////////</span>\n<span class=\"kt\">int</span> <span class=\"nf\">main</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n  <span class=\"n\">ServerConfig</span> <span class=\"n\">serverConfig</span><span class=\"p\">;</span>\n  <span class=\"n\">Server</span> <span class=\"n\">server</span><span class=\"p\">(</span><span class=\"n\">serverConfig</span><span class=\"p\">);</span>\n  <span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">Run</span><span class=\"p\">();</span>\n  <span class=\"k\">return</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</pre></div>\n\n\n<p><strong>Expected behavior:</strong></p>\n<p>The program should run and finish without any problems.</p>\n<p><strong>Actual behavior:</strong></p>\n<p>At the end of the execution, the program fails with this output:</p>\n<p><code>double free or corruption (fasttop)</code><br />\n<code>Aborted (core dumped)</code></p>\n<p><strong>Reproduces how often:</strong></p>\n<p>Always.</p>\n<h1 id=\"markdown-header-versions\">Versions</h1>\n<p>gcc (Ubuntu 8.3.0-6ubuntu1~18.04.1) 8.3.0</p>\n<p>ldd (Ubuntu GLIBC 2.27-3ubuntu1) 2.27</p>\n<h1 id=\"markdown-header-additional-information\">Additional Information</h1>\n<p>When running with valgrind:</p>\n<p><code>valgrind --keep-stacktraces=alloc-and-free crash_test</code></p>\n<blockquote>\n<p>==29049== Memcheck, a memory error detector<br />\n==29049== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.<br />\n==29049== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info<br />\n==29049== Command: bin/crash_test<br />\n==29049==<br />\n==29049== Invalid free() / delete / delete[] / realloc()<br />\n==29049== at 0x4C3123B: operator delete(void*) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)<br />\n==29049== by 0x580F040: __run_exit_handlers (exit.c:108)<br />\n==29049== by 0x580F139: exit (exit.c:139)<br />\n==29049== by 0x57EDB9D: (below main) (libc-start.c:344)<br />\n==29049== Address 0x1f97e1d0 is 0 bytes inside a block of size 29 free'd<br />\n==29049== at 0x4C3123B: operator delete(void*) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)<br />\n==29049== by 0x580F040: __run_exit_handlers (exit.c:108)<br />\n==29049== by 0x580F139: exit (exit.c:139)<br />\n==29049== by 0x57EDB9D: (below main) (libc-start.c:344)<br />\n==29049== Block was alloc'd at<br />\n==29049== at 0x4C3017F: operator new(unsigned long) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)<br />\n==29049== by 0x2ABF365D: ??? (in /opt/ros/melodic/lib/liboctomap.so.1.9.0)<br />\n==29049== by 0x4010732: call_init (dl-init.c:72)<br />\n==29049== by 0x4010732: _dl_init (dl-init.c:119)<br />\n==29049== by 0x40151FE: dl_open_worker (dl-open.c:522)<br />\n==29049== by 0x59332DE: _dl_catch_exception (dl-error-skeleton.c:196)<br />\n==29049== by 0x40147C9: _dl_open (dl-open.c:605)<br />\n==29049== by 0x972CF95: dlopen_doit (dlopen.c:66)<br />\n==29049== by 0x59332DE: _dl_catch_exception (dl-error-skeleton.c:196)<br />\n==29049== by 0x593336E: _dl_catch_error (dl-error-skeleton.c:215)<br />\n==29049== by 0x972D734: _dlerror_run (dlerror.c:162)<br />\n==29049== by 0x972D050: dlopen@@GLIBC_2.2.5 (dlopen.c:87)<br />\n==29049== by 0x663A3A9: ignition::plugin::Loader::Implementation::LoadLib(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) (<a data-is-external-link=\"true\" href=\"http://Loader.cc:457\" rel=\"nofollow\">Loader.cc:457</a>)<br />\n==29049==<br />\n==29049==<br />\n==29049== HEAP SUMMARY:<br />\n==29049== in use at exit: 663,703 bytes in 9,163 blocks<br />\n==29049== total heap usage: 211,095 allocs, 201,934 frees, 31,648,420 bytes allocated<br />\n==29049==<br />\n==29049== LEAK SUMMARY:<br />\n==29049== definitely lost: 3,573 bytes in 212 blocks<br />\n==29049== indirectly lost: 0 bytes in 0 blocks<br />\n==29049== possibly lost: 0 bytes in 0 blocks<br />\n==29049== still reachable: 660,130 bytes in 8,951 blocks<br />\n==29049== suppressed: 0 bytes in 0 blocks<br />\n==29049== Rerun with --leak-check=full to see details of leaked memory<br />\n==29049==<br />\n==29049== For counts of detected and suppressed errors, rerun with: -v<br />\n==29049== ERROR SUMMARY: 2 errors from 1 contexts (suppressed: 0 from 0)</p>\n</blockquote>\n<p>Pointed to line: <a data-is-external-link=\"true\" href=\"#!/ignitionrobotics/ign-plugin/src/8f724376b94bf6e298a7d66a37e5e5a68a329409/loader/src/Loader.cc#lines-457\" rel=\"nofollow\">#!/ignitionrobotics/ign-plugin/src/8f724376b94bf6e298a7d66a37e5e5a68a329409/loader/src/Loader.cc#lines-457</a></p>\n<p>If running with address sanitizer, we get:</p>\n<blockquote>\n<p>=================================================================<br />\n==16996==ERROR: AddressSanitizer: attempting double-free on 0x60300026dc10 in thread T0:<br />\n#0 0x55fafdc08dc0 in operator delete(void*) (bin/crash_test+0xd7dc0)<br />\n<del><a href=\"#!/ignitionrobotics/ign-gazebo/issues/1/weird-sphere-movement\" rel=\"nofollow\" title=\"Weird sphere movement\" class=\"ap-connect-link\"><s>#1</s></a></del> 0x7f658031e040 (/lib/x86_64-linux-gnu/libc.so.6+0x43040)<br />\n<del><a href=\"#!/ignitionrobotics/ign-gazebo/issues/2/transport-segfault-on-shutdown\" rel=\"nofollow\" title=\"Transport segfault on shutdown\" class=\"ap-connect-link\"><s>#2</s></a></del> 0x7f658031e139 in exit (/lib/x86_64-linux-gnu/libc.so.6+0x43139)<br />\n<a href=\"#!/ignitionrobotics/ign-gazebo/issues/3/pose-components\" rel=\"nofollow\" title=\"Pose components\" class=\"ap-connect-link\">#3</a> 0x7f65802fcb9d in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b9d)<br />\n<a href=\"#!/ignitionrobotics/ign-gazebo/issues/4/gui-rapid-stepping-puts-play-pause-button\" rel=\"nofollow\" title=\"[GUI] Rapid stepping puts play/pause button in bad state\" class=\"ap-connect-link\">#4</a> 0x55fafdb39b89 in _start (build/bin/crash_test+0x8b89)</p>\n<p>0x60300026dc10 is located 0 bytes inside of 29-byte region [0x60300026dc10,0x60300026dc2d)<br />\nfreed by thread T0 here:<br />\n#0 0x55fafdc08dc0 in operator delete(void*) (build/bin/crash_test+0xd7dc0)<br />\n<del><a href=\"#!/ignitionrobotics/ign-gazebo/issues/1/weird-sphere-movement\" rel=\"nofollow\" title=\"Weird sphere movement\" class=\"ap-connect-link\"><s>#1</s></a></del> 0x7f658031e040 (/lib/x86_64-linux-gnu/libc.so.6+0x43040)</p>\n<p>previously allocated by thread T0 here:<br />\n#0 0x55fafdc07f10 in operator new(unsigned long) (build/bin/crash_test+0xd6f10)<br />\n<del><a href=\"#!/ignitionrobotics/ign-gazebo/issues/1/weird-sphere-movement\" rel=\"nofollow\" title=\"Weird sphere movement\" class=\"ap-connect-link\"><s>#1</s></a></del> 0x7f655b39565d (/opt/ros/melodic/lib/liboctomap.so.1.9+0x1465d)</p>\n<p>SUMMARY: AddressSanitizer: double-free (build/bin/crash_test+0xd7dc0) in operator delete(void*)<br />\n==16996==ABORTING</p>\n</blockquote>\n<p>\u200c</p>", "type": "rendered"}, "assignee": null, "state": "resolved", "version": null, "edited_on": null, "created_on": "2020-03-27T21:53:53.002890+00:00", "milestone": null, "updated_on": "2020-03-28T20:30:20.701094+00:00", "type": "issue", "id": 54}